<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Consumo - Midnight Club</title>
    <!-- Libs -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/base.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar injected by layout.js -->
        <nav id="sidebar-container"></nav>

        <!-- Main Content -->
        <main>
            <header id="header-container"></header>
            
            <div id="page-content">
                <div class="content-header">
                    <div>
                        <h2>Análisis de Consumo</h2>
                        <p class="text-muted">Importa consumos, calcula stock ideal y revisa tendencias.</p>
                    </div>
                </div>
                <div id="content-herramientas-consumo" class="card">
                    <div class="card-header">
                        <div>
                            <h3>Flujo de análisis</h3>
                            <p class="text-muted">Carga archivos, valida el mapeo y genera recomendaciones.</p>
                        </div>
                    </div>
                    <div id="analysis-tabs-container" class="tab-container analysis-tabs">
                        <!-- Rendered by JS -->
                    </div>

                    <!-- Tab: Importar -->
                    <div id="analysis-tab-importar" class="analysis-section">
                        <div class="analysis-panel">
                            <h4>Importar Consumo (Excel)</h4>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label for="import-date">Fecha Operativa</label>
                                    <input type="date" id="import-date">
                                </div>
                                <div class="form-field span-2">
                                    <label for="import-file">Archivo Excel</label>
                                    <input type="file" id="import-file" accept=".xlsx, .xls" onchange="window.handleFileSelect(event)">
                                    <small id="import-file-name" class="form-hint"></small>
                                </div>
                            </div>
                        </div>
                        <div id="import-preview" class="analysis-panel"></div>
                    </div>

                    <!-- Tab: Analizar -->
                    <div id="analysis-tab-analizar" class="analysis-section hidden">
                        <div class="analysis-panel">
                            <h4>Calcular Stock Ideal</h4>
                            <div class="analysis-row">
                                <div class="form-field">
                                    <label for="analyze-date-start">Fecha inicio</label>
                                    <input type="date" id="analyze-date-start">
                                </div>
                                <div class="form-field">
                                    <label for="analyze-date-end">Fecha fin</label>
                                    <input type="date" id="analyze-date-end">
                                </div>
                                <div class="form-field">
                                    <label>&nbsp;</label>
                                    <button class="btn-primary" id="btn-analyze-ideal">Analizar</button>
                                </div>
                            </div>
                        </div>
                        <div id="analysis-results" class="analysis-panel">
                            <p class="text-muted">Seleccione un rango para calcular recomendaciones.</p>
                        </div>
                    </div>

                    <!-- Tab: Histórica -->
                    <div id="analysis-tab-historica" class="analysis-section hidden">
                        <div class="analysis-panel">
                            <h4>Tendencias de Consumo</h4>
                            <div class="analysis-chart">
                                <canvas id="history-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/core/config.js"></script>
    <script src="../../assets/js/layout.js"></script>
    <script src="../../assets/js/modules/auth.js"></script>
    <script src="../../assets/js/modules/herramientas-analisis.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Init Auth
            if (window.AuthModule) await window.AuthModule.init();

            // 2. Determine Role (Robust check)
            let role = 'user';
            const sb = window.sb;
            if (sb) {
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    const { data: profile } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
                    if (profile) role = profile.role.toLowerCase();
                }
            }

            // 3. Conditional Layout
            if (role === 'operativo') {
                // --- OPERATIVO MODE (Red Aurora Theme) ---
                console.log('Mode: Operativo (Minimalist)');

                // A. Swap CSS
                const baseCss = document.querySelector('link[href*="base.css"]');
                if (baseCss) baseCss.remove();

                const newLink = document.createElement('link');
                newLink.rel = 'stylesheet';
                newLink.href = '../../assets/css/index.css'; 
                document.head.appendChild(newLink);

                // B. Add Body Class & Styling overrides via JS (or inject style block)
                document.body.classList.add('operativo-mode');
                
                // Add specific overrides for this page to look good in "Red Mode"
                const style = document.createElement('style');
                style.innerHTML = `

                    /* --- Operativo Mode (Red Aurora) --- */
                    body.operativo-mode {
                        background: radial-gradient(circle at 50% 30%, #5e0a0a 0%, #1a0000 60%, #000000 100%);
                        color: #ffffff !important;
                        padding: 20px;
                        min-height: 100vh;
                        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
                        display: block;
                        overflow-y: auto;
                    }

                    .operativo-mode .app-container { 
                        display: block;
                        width: 100%;
                        max-width: 1000px;
                        margin: 0 auto;
                    }

                    .operativo-mode main {
                        display: block;
                        width: 100%;
                    }

                    .operativo-mode #page-content {
                        display: flex;
                        flex-direction: column;
                        gap: 16px;
                    }
                    
                    .operativo-mode #sidebar-container, 
                    .operativo-mode #header-container { display: none; }

                    /* Glass Card */
                    .operativo-mode .card {
                        background: rgba(255, 255, 255, 0.03);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        border-radius: 24px;
                        padding: 32px;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                        animation: fadeInUp 0.5s ease-out;
                    }

                    /* Typography */
                    .operativo-mode h3 { 
                        font-weight: 700; font-size: 24px; margin-bottom: 4px; letter-spacing: -0.01em; 
                    }
                    .operativo-mode h4 {
                        font-weight: 600; font-size: 18px; margin-bottom: 16px; color: rgba(255,255,255,0.9);
                    }
                    .operativo-mode .text-muted { 
                        color: rgba(255, 255, 255, 0.5) !important; font-size: 14px; 
                    }

                    .operativo-mode .content-header h2 {
                        margin: 0;
                        font-size: 28px;
                        letter-spacing: -0.01em;
                    }

                    .operativo-mode .analysis-section {
                        display: flex;
                        flex-direction: column;
                        gap: 16px;
                    }

                    .operativo-mode .analysis-panel {
                        background: rgba(0, 0, 0, 0.25);
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        border-radius: 16px;
                        padding: 18px;
                    }

                    .operativo-mode .analysis-preview {
                        max-height: 60vh;
                        overflow: auto;
                        border-radius: 14px;
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        background: rgba(0,0,0,0.3);
                    }

                    .operativo-mode table {
                        width: 100%;
                        border-collapse: collapse;
                    }

                    /* Tabs */
                    .operativo-mode .tab-container {
                        display: flex; gap: 10px; margin: 24px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 12px;
                    }
                    .operativo-mode .tab-btn {
                        background: transparent; border: none; color: rgba(255,255,255,0.6);
                        padding: 8px 16px; font-size: 14px; font-weight: 500; cursor: pointer;
                        border-radius: 20px; transition: all 0.2s;
                    }
                    .operativo-mode .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
                    .operativo-mode .tab-btn.active {
                        background: #FF3B30; color: white; box-shadow: 0 2px 10px rgba(255, 59, 48, 0.3);
                    }

                    /* Forms & Inputs */
                    .operativo-mode .form-grid {
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
                    }
                    .operativo-mode label {
                        display: block; font-size: 12px; font-weight: 500; text-transform: uppercase;
                        letter-spacing: 0.05em; color: rgba(255,255,255,0.4); margin-bottom: 8px;
                    }
                    .operativo-mode input, .operativo-mode select {
                        width: 100%; padding: 12px 16px;
                        background: rgba(0, 0, 0, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        color: white; font-size: 14px;
                        transition: all 0.2s;
                    }
                    .operativo-mode input:focus {
                        outline: none; border-color: #FF3B30; background: rgba(0,0,0,0.4);
                    }
                    .operativo-mode input[type="file"] {
                        padding: 10px; cursor: pointer;
                    }

                    /* Buttons */
                    .operativo-mode .btn-primary {
                        background: #FF3B30; border: none; color: white;
                        padding: 12px 24px; border-radius: 12px; font-weight: 600;
                        cursor: pointer; transition: all 0.2s;
                        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.2);
                    }
                    .operativo-mode .btn-primary:hover {
                        background: #D70015; transform: translateY(-1px);
                        box-shadow: 0 6px 16px rgba(255, 59, 48, 0.3);
                    }

                    /* Back Button */
                    .back-btn {
                        display: inline-flex; align-items: center; gap: 8px;
                        background: rgba(255, 255, 255, 0.05);
                        padding: 10px 20px; border-radius: 20px;
                        color: rgba(255,255,255,0.8); text-decoration: none;
                        font-size: 14px; font-weight: 500; margin-bottom: 24px;
                        border: 1px solid rgba(255,255,255,0.05);
                        transition: all 0.2s;
                    }
                    .back-btn:hover {
                        background: rgba(255, 255, 255, 0.1); color: white; border-color: rgba(255,255,255,0.1);
                    }

                    /* Animations */
                    @keyframes fadeInUp {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);

                // C. Inject Back Button
                const container = document.querySelector('.app-container main'); // Insert before content
                const backBtn = document.createElement('a');
                backBtn.href = '../operativo/operativo-index.html';
                backBtn.className = 'back-btn';
                backBtn.innerHTML = '← Volver al Dashboard';
                if (container) container.prepend(backBtn);

            } else {
                // --- ADMIN MODE (Standard) ---
                console.log('Mode: Admin/Standard');
                window.LayoutModule.injectLayout('herramientas-analisis');
            }
            
            // 4. Load Page Logic
            if (window.loadConsumptionAnalysis) {
                window.loadConsumptionAnalysis();
            } else {
                console.error('loadConsumptionAnalysis not found in analisis.js');
            }
        });
    </script>
</body>
</html>
