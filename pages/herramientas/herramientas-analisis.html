<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Consumo - Midnight Club</title>
    <!-- Libs -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/base.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar injected by layout.js -->
        <nav id="sidebar-container"></nav>

        <!-- Main Content -->
        <main>
            <header id="header-container"></header>
            
            <div id="page-content">
                <div id="content-herramientas-consumo" class="card">
                    <div class="card-header">
                        <div>
                            <h3>Análisis de Consumo</h3>
                            <p class="text-muted">Importa consumos, calcula stock ideal y revisa tendencias.</p>
                        </div>
                    </div>
                    <div id="analysis-tabs-container" class="tab-container">
                        <!-- Rendered by JS -->
                    </div>

                    <!-- Tab: Importar -->
                    <div id="analysis-tab-importar" class="analysis-section">
                        <div class="analysis-panel">
                            <h4>Importar Consumo (Excel)</h4>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label for="import-date">Fecha Operativa</label>
                                    <input type="date" id="import-date">
                                </div>
                                <div class="form-field span-2">
                                    <label for="import-file">Archivo Excel</label>
                                    <input type="file" id="import-file" accept=".xlsx, .xls" onchange="window.handleFileSelect(event)">
                                    <small id="import-file-name" class="form-hint"></small>
                                </div>
                            </div>
                        </div>
                        <div id="import-preview" class="analysis-panel"></div>
                    </div>

                    <!-- Tab: Analizar -->
                    <div id="analysis-tab-analizar" class="analysis-section hidden">
                        <div class="analysis-panel">
                            <h4>Calcular Stock Ideal</h4>
                            <div class="analysis-row">
                                <div class="form-field">
                                    <label for="analyze-date-start">Fecha inicio</label>
                                    <input type="date" id="analyze-date-start">
                                </div>
                                <div class="form-field">
                                    <label for="analyze-date-end">Fecha fin</label>
                                    <input type="date" id="analyze-date-end">
                                </div>
                                <div class="form-field">
                                    <label>&nbsp;</label>
                                    <button class="btn-primary" id="btn-analyze-ideal">Analizar</button>
                                </div>
                            </div>
                        </div>
                        <div id="analysis-results" class="analysis-panel">
                            <p class="text-muted">Seleccione un rango para calcular recomendaciones.</p>
                        </div>
                    </div>

                    <!-- Tab: Histórica -->
                    <div id="analysis-tab-historica" class="analysis-section hidden">
                        <div class="analysis-panel">
                            <h4>Tendencias de Consumo</h4>
                            <div class="analysis-chart">
                                <canvas id="history-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../../assets/js/core/config.js"></script>
    <script src="../../assets/js/layout.js"></script>
    <script src="../../assets/js/modules/auth.js"></script>
    <script src="../../assets/js/modules/herramientas-analisis.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Init Auth
            if (window.AuthModule) await window.AuthModule.init();

            // 2. Determine Role (Robust check)
            let role = 'user';
            const sb = window.sb;
            if (sb) {
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    const { data: profile } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
                    if (profile) role = profile.role.toLowerCase();
                }
            }

            // 3. Conditional Layout
            if (role === 'operativo') {
                // --- OPERATIVO MODE (Red Aurora Theme) ---
                console.log('Mode: Operativo (Minimalist)');

                // A. Swap CSS
                const baseCss = document.querySelector('link[href*="base.css"]');
                if (baseCss) baseCss.remove();

                const newLink = document.createElement('link');
                newLink.rel = 'stylesheet';
                newLink.href = '../../assets/css/index.css'; 
                document.head.appendChild(newLink);

                // B. Add Body Class & Styling overrides via JS (or inject style block)
                document.body.classList.add('operativo-mode');
                
                // Add specific overrides for this page to look good in "Red Mode"
                const style = document.createElement('style');
                style.innerHTML = `
                    body.operativo-mode {
                        background: radial-gradient(circle at 50% 30%, #5e0a0a 0%, #1a0000 60%, #000000 100%); /* Force Red Bg */
                        color: white !important;
                        padding: 20px;
                        min-height: 100vh;
                    }
                    .operativo-mode .app-container { grid-template-columns: 1fr; }
                    .operativo-mode #sidebar-container, .operativo-mode #header-container { display: none; }
                    .operativo-mode .card {
                        background: rgba(255, 255, 255, 0.05); /* Glass */
                        border: 1px solid rgba(255,255,255,0.1);
                        color: white;
                        border-radius: 24px;
                    }
                    .operativo-mode h3 { color: white; }
                    .operativo-mode .text-muted { color: rgba(255,255,255,0.6) !important; }
                    .operativo-mode label { color: rgba(255,255,255,0.8); }
                    .operativo-mode input { 
                        background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white;
                    }
                    /* Back Button */
                    .back-btn {
                        display: inline-flex; align-items: center; gap: 8px;
                        background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px;
                        color: white; text-decoration: none; font-size: 14px; margin-bottom: 20px;
                        backdrop-filter: blur(10px); transition: all 0.2s;
                    }
                    .back-btn:hover { background: rgba(255,255,255,0.2); }
                `;
                document.head.appendChild(style);

                // C. Inject Back Button
                const container = document.querySelector('.app-container main'); // Insert before content
                const backBtn = document.createElement('a');
                backBtn.href = '../operativo/operativo-index.html';
                backBtn.className = 'back-btn';
                backBtn.innerHTML = '← Volver al Dashboard';
                if (container) container.prepend(backBtn);

            } else {
                // --- ADMIN MODE (Standard) ---
                console.log('Mode: Admin/Standard');
                window.LayoutModule.injectLayout('herramientas-analisis');
            }
            
            // 4. Load Page Logic
            if (window.loadConsumptionAnalysis) {
                window.loadConsumptionAnalysis();
            } else {
                console.error('loadConsumptionAnalysis not found in analisis.js');
            }
        });
    </script>
</body>
</html>
